---
title: "stat summary of Ggplot2"
output:
  github_document:
    toc: true
    toc_depth: 3 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)

```


> **DISCLAIMER:** This note is based on (mostly copy pasted from) these sources
> [1] [demystifying-stat-layers-ggplot2](https://yjunechoe.github.io/posts/2020-09-26-demystifying-stat-layers-ggplot2/)

## Demystifying stat_ layers in {ggplot2}

`stat_summary` works in the following order:

1. The data that is passed into `ggplot()` is inherited to `stat_summary` if one is not provided

2. The function passed into the `fun.data` argument applies transformations to a part of data (that was inherited/provided). `fun.data` defaults to `mean_se` function.

3. The result is then passed into `geom` provided in the `geom` argument of the `stat_summary` (`geom` defaults to `pointrange` if not specified).

4. If the transformed data contains all the required mappings for the geom, then geom will be printed.


- **`stat_summary` summarizes one dimension of the data.**


```{r warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(tibble)
```



```{r}
height_df <- tibble(group = "A",
                    height = rnorm(30, 170, 10))

height_df %>% 
  ggplot(aes(x = group, y = height)) +
  stat_summary()
```


So as the points mentioned above, `geom = pointrange` and `fun.data = mean_se` are used here.

To verify this, we can actually look into the transformed data by `mean_se` and by `stat_summary`.

The `mean_se` function internally looks like,

```{r}
mean_se

mean_se(height_df$height)
```

```{r}
point_range_plot <- height_df %>% 
  ggplot(aes(group, height)) + 
  stat_summary()

layer_data(point_range_plot, 1) # here 1 means 1st layer which is pointrange here,

# but since here only one geom is used, so if we omit 1, consequence will be same.
```

which is similar as above, so it is proved that `stat_summary` using `mean_se` as default.

### Some Usecases of stat_summary

#### Error bar showing 95% confidence Interval


```{r}
data(penguins, package = "palmerpenguins")

peng <- na.omit(penguins)
```


```{r}
peng %>% 
  ggplot(aes(sex, body_mass_g)) +
  stat_summary(
    fun.data = ~mean_se(.x, mult = 1.96),
    geom = "errorbar"
  )
```


#### A color coded bar plot of median

Here we want to color a bar of medians if median for a specific bar is less than a threshold (say 40).

```{r}

# custom function for fun.data

calc_median_and_color <- function(x, threshold = 40) {
  tibble(y = median(x)) %>% 
    mutate(
      fill = if_else(y < threshold, "pink",  "gray35")
    )
}

peng %>% 
  ggplot(aes(species, bill_length_mm)) +
  stat_summary(
    fun.data = calc_median_and_color,
    geom = "bar"
  )

```


Here we have deliberately used the colname `fill` so that it used as an argument of geom.


#### pointrange plot with changing size

```{r}
peng %>% 
  ggplot(aes(species, bill_length_mm)) +
  stat_summary(
    fun.data = \(x) {
      scaled_size <- length(x) / nrow(peng)
      mean_se(x) %>% mutate(size = scaled_size)
    }
  )
```


